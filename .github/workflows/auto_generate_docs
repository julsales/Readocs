name: Gerar DocumentaÃ§Ã£o AutomÃ¡tica

on:
  push:
    branches: [ main, master ]  # Roda a cada push na branch principal
    paths-ignore:
      - 'README.md'      # Ignora se sÃ³ mudou README
      - 'CHANGELOG.md'   # Ignora se sÃ³ mudou CHANGELOG
      - '.github/**'     # Ignora mudanÃ§as nos workflows
  
  # Permite execuÃ§Ã£o manual tambÃ©m
  workflow_dispatch:
    inputs:
      mensagem_commit:
        description: 'Mensagem personalizada para o PR'
        required: false
        default: 'docs: atualizaÃ§Ã£o automÃ¡tica da documentaÃ§Ã£o'

jobs:
  gerar-documentacao:
    runs-on: ubuntu-latest
    
    # Evita rodar se for um bot que fez o commit
    if: github.actor != 'github-actions[bot]' && github.actor != 'dependabot[bot]'
    
    steps:
      - name: Checkout do RepositÃ³rio
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # NecessÃ¡rio para ver histÃ³rico

      - name: Configurar Ambiente Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Instalar DependÃªncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verificar se jÃ¡ existe PR de documentaÃ§Ã£o
        id: check_pr
        run: |
          # Verifica se jÃ¡ existe um PR aberto para documentaÃ§Ã£o
          existing_pr=$(gh pr list --state open --label "documentation" --json number --jq '.[0].number // empty')
          
          if [ ! -z "$existing_pr" ]; then
            echo "existing_pr=$existing_pr" >> $GITHUB_OUTPUT
            echo "ðŸ“‹ PR #$existing_pr jÃ¡ existe para documentaÃ§Ã£o"
          else
            echo "existing_pr=" >> $GITHUB_OUTPUT
            echo "âœ¨ Nenhum PR de documentaÃ§Ã£o encontrado"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Criar branch para documentaÃ§Ã£o
        if: steps.check_pr.outputs.existing_pr == ''
        run: |
          # Criar branch Ãºnica com timestamp
          timestamp=$(date +%Y%m%d_%H%M%S)
          branch_name="docs/auto-update-$timestamp"
          
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git checkout -b $branch_name
          echo "branch_name=$branch_name" >> $GITHUB_ENV
          echo "ðŸŒ³ Branch criada: $branch_name"

      - name: Executar Agentes de DocumentaÃ§Ã£o
        if: steps.check_pr.outputs.existing_pr == ''
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          COMMIT_MESSAGE: ${{ github.event.inputs.mensagem_commit || 'docs: atualizaÃ§Ã£o automÃ¡tica da documentaÃ§Ã£o' }}
        run: |
          cd readocs
          echo "ðŸ¤– Gerando documentaÃ§Ã£o..."
          python main.py

      - name: Verificar mudanÃ§as e criar PR
        if: steps.check_pr.outputs.existing_pr == ''
        id: create_pr
        run: |
          if git diff --quiet HEAD -- README.md CHANGELOG.md; then
            echo "ðŸ“ Nenhuma mudanÃ§a detectada na documentaÃ§Ã£o"
            echo "changes=false" >> $GITHUB_OUTPUT
          else
            echo "ðŸ“ MudanÃ§as detectadas, criando PR..."
            
            # Commit das mudanÃ§as
            git add README.md CHANGELOG.md
            
            # Mensagem do commit baseada no Ãºltimo commit do usuÃ¡rio
            last_commit=$(git log -1 --pretty=format:"%s" HEAD~1)
            commit_msg="${{ github.event.inputs.mensagem_commit || 'docs: atualizaÃ§Ã£o automÃ¡tica da documentaÃ§Ã£o' }}"
            
            git commit -m "$commit_msg

            ðŸ¤– DocumentaÃ§Ã£o gerada automaticamente baseada em: $last_commit
            
            MudanÃ§as detectadas:
            $(git diff --name-only HEAD~1 | grep -E '\.(py|md|txt|yml|yaml)$' | head -10)
            "
            
            # Push da branch
            git push origin ${{ env.branch_name }}
            
            # Criar PR
            pr_body="## ðŸ“š AtualizaÃ§Ã£o AutomÃ¡tica da DocumentaÃ§Ã£o

            Esta documentaÃ§Ã£o foi gerada automaticamente pelos agentes IA baseada nas mudanÃ§as recentes no cÃ³digo.

            ### ðŸ” Baseado no commit:
            **$last_commit** ($(git log -1 --pretty=format:"%h" HEAD~1))

            ### ðŸ“‹ Arquivos atualizados:
            $(git diff --name-only HEAD~1 | grep -E 'README\.md|CHANGELOG\.md' | sed 's/^/- /')

            ### âœ… RevisÃ£o necessÃ¡ria:
            - [ ] README.md estÃ¡ correto e completo
            - [ ] CHANGELOG.md tem as informaÃ§Ãµes adequadas  
            - [ ] Linguagem estÃ¡ em portuguÃªs
            - [ ] NÃ£o hÃ¡ informaÃ§Ãµes sensÃ­veis expostas

            ### ðŸ¤– Como foi gerado:
            - **Agente**: Claude Haiku (Anthropic)
            - **Trigger**: Push em ${{ github.ref_name }}
            - **Workflow**: ${{ github.workflow }}

            ---
            ðŸ’¡ **Dica**: Se aprovar, faÃ§a merge. Se nÃ£o gostar, feche este PR e a documentaÃ§Ã£o nÃ£o serÃ¡ alterada."

            # Criar o PR
            pr_number=$(gh pr create \
              --title "ðŸ“š AtualizaÃ§Ã£o automÃ¡tica da documentaÃ§Ã£o" \
              --body "$pr_body" \
              --label "documentation,automated" \
              --assignee ${{ github.actor }} \
              --json number --jq .number)
            
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "pr_number=$pr_number" >> $GITHUB_OUTPUT
            echo "âœ… PR #$pr_number criado com sucesso!"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comentar no PR existente (se houver)
        if: steps.check_pr.outputs.existing_pr != ''
        run: |
          pr_number="${{ steps.check_pr.outputs.existing_pr }}"
          
          comment="ðŸ”„ **Nova tentativa de atualizaÃ§Ã£o detectada**

          Commit que disparou: **${{ github.event.head_commit.message }}** (${{ github.sha }})
          
          â„¹ï¸ Este PR ainda estÃ¡ aberto, entÃ£o nÃ£o foi criado um novo. Se quiser regenerar a documentaÃ§Ã£o:
          1. Feche este PR atual
          2. FaÃ§a um novo push ou execute o workflow manualmente
          
          Ou execute manualmente: \`gh workflow run \"${{ github.workflow }}\"\`"
          
          gh pr comment $pr_number --body "$comment"
          echo "ðŸ’¬ ComentÃ¡rio adicionado ao PR #$pr_number"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Resumo da ExecuÃ§Ã£o
        if: always()
        run: |
          echo "## ðŸ“Š Resumo da ExecuÃ§Ã£o" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow**: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY  
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Autor**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_pr.outputs.existing_pr }}" != "" ]; then
            echo "- **Status**: â„¹ï¸ PR #${{ steps.check_pr.outputs.existing_pr }} jÃ¡ existe" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.create_pr.outputs.changes }}" == "true" ]; then
            echo "- **Status**: âœ… PR #${{ steps.create_pr.outputs.pr_number }} criado" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status**: ðŸ“ Nenhuma mudanÃ§a necessÃ¡ria" >> $GITHUB_STEP_SUMMARY
          fi
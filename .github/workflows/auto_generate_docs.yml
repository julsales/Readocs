name: ğŸ“š Gerar DocumentaÃ§Ã£o Automaticamente

on:
  push:
    branches: [main, master]
  workflow_dispatch:

# Adiciona permissÃµes necessÃ¡rias
permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  doc-update:
    name: Atualizar documentaÃ§Ã£o automaticamente
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”„ Checkout do repositÃ³rio
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ› ï¸ Instalar dependÃªncias necessÃ¡rias
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: ğŸ” Verificar se jÃ¡ existe um PR aberto
        id: check_pr
        run: |
          pr_info=$(gh pr list --state open --search "AtualizaÃ§Ã£o automÃ¡tica da documentaÃ§Ã£o in:title" --json number,headRefName --jq '.[0]')
          
          if [ "$pr_info" != "null" ] && [ -n "$pr_info" ]; then
            pr_number=$(echo "$pr_info" | jq -r '.number')
            branch_name=$(echo "$pr_info" | jq -r '.headRefName')
            echo "PR existente encontrado: #$pr_number na branch: $branch_name"
            echo "existing_pr=$pr_number" >> $GITHUB_OUTPUT
            echo "existing_branch=$branch_name" >> $GITHUB_OUTPUT
            echo "has_existing_pr=true" >> $GITHUB_OUTPUT
          else
            echo "Nenhum PR existente encontrado"
            echo "existing_pr=" >> $GITHUB_OUTPUT
            echo "existing_branch=" >> $GITHUB_OUTPUT
            echo "has_existing_pr=false" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸª„ Usar branch existente ou criar nova
        run: |
          if [ "${{ steps.check_pr.outputs.has_existing_pr }}" == "true" ]; then
            # Usar branch existente
            branch_name="${{ steps.check_pr.outputs.existing_branch }}"
            echo "ğŸ”„ Usando branch existente: $branch_name"
            git fetch origin $branch_name
            git checkout $branch_name
          else
            # Criar nova branch
            timestamp=$(date +%Y%m%d_%H%M%S)
            branch_name="docs/auto-update-$timestamp"
            echo "ğŸª„ Criando nova branch: $branch_name"
            git checkout -b $branch_name
          fi
          echo "branch_name=$branch_name" >> $GITHUB_ENV

      - name: ğŸ“¦ Executar Agentes de DocumentaÃ§Ã£o
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
        run: |
          cd readocs
          python main.py

      - name: ğŸ”§ Substituir {{BADGE_SECTION}} pelo HTML de badges
        run: |
          BADGE_HTML='<div align="center">

          <img src="https://img.shields.io/github/repo-size/usuario/repositorio?style=for-the-badge">
          <img src="https://img.shields.io/github/languages/count/usuario/repositorio?style=for-the-badge">
          <img src="https://img.shields.io/github/forks/usuario/repositorio?style=for-the-badge">
          <img src="https://img.shields.io/bitbucket/issues/usuario/repositorio?style=for-the-badge">
          <img src="https://img.shields.io/bitbucket/pr-raw/usuario/repositorio?style=for-the-badge">
          <br><br>
          <img src="https://via.placeholder.com/480x320.png?text=Imagem+do+Projeto" height="320">
          </div>'

          awk -v replacement="$BADGE_HTML" '
            {
              gsub(/\{\{BADGE_SECTION\}\}/, replacement)
              print
            }
          ' README.md > README.tmp && mv README.tmp README.md

      - name: ğŸ” Verificar mudanÃ§as
        id: check_changes
        run: |
          git add README.md CHANGELOG.md || true
          if git diff --cached --quiet; then
            echo "ğŸ“ Nenhuma mudanÃ§a detectada na documentaÃ§Ã£o"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“ MudanÃ§as detectadas na documentaÃ§Ã£o"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            git status
          fi

      - name: âœ… Commit e push mudanÃ§as
        if: steps.check_changes.outputs.has_changes == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          commit_msg="docs: atualizaÃ§Ã£o automÃ¡tica da documentaÃ§Ã£o [skip ci]"
          if [ "${{ steps.check_pr.outputs.has_existing_pr }}" == "true" ]; then
            commit_msg="docs: atualizaÃ§Ã£o da documentaÃ§Ã£o (PR #${{ steps.check_pr.outputs.existing_pr }}) [skip ci]"
          fi
          
          git commit -m "$commit_msg"
          git push origin HEAD
          
          echo "âœ… Push realizado para branch: ${{ env.branch_name }}"

      - name: ğŸ“¤ Criar Pull Request para main (se novo)
        if: steps.check_changes.outputs.has_changes == 'true' && steps.check_pr.outputs.has_existing_pr == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pr_body="## ğŸ“š AtualizaÃ§Ã£o AutomÃ¡tica da DocumentaÃ§Ã£o

          Esta Ã© uma atualizaÃ§Ã£o automÃ¡tica da documentaÃ§Ã£o gerada pelos agentes IA.

          ### ğŸ¤– MudanÃ§as Realizadas:
          - âœ… README.md atualizado com anÃ¡lise do projeto
          - âœ… CHANGELOG.md atualizado com nova versÃ£o
          
          ### ğŸ“‹ Detalhes:
          - **Trigger**: ${{ github.event_name }}
          - **Branch de origem**: ${{ env.branch_name }}
          - **Branch de destino**: main
          - **Commit**: ${{ github.sha }}
          - **Autor**: ${{ github.actor }}
          
          ### âš ï¸ RevisÃ£o NecessÃ¡ria
          Por favor, revise as mudanÃ§as antes de fazer o merge para a main.
          
          ---
          ğŸ¤– *Gerado automaticamente pelo GitHub Actions*"

          pr_url=$(gh pr create \
            --title "ğŸ“š AtualizaÃ§Ã£o automÃ¡tica da documentaÃ§Ã£o" \
            --body "$pr_body" \
            --base main \
            --head ${{ env.branch_name }} \
            --label "documentation")

          echo "âœ… Novo PR criado para merge na main!"
          echo "ğŸ”— Verifique em: $pr_url"

      - name: ğŸ”„ Atualizar PR existente
        if: steps.check_changes.outputs.has_changes == 'true' && steps.check_pr.outputs.has_existing_pr == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ”„ PR #${{ steps.check_pr.outputs.existing_pr }} foi atualizado com novas mudanÃ§as"
          
          # Adiciona comentÃ¡rio no PR sobre a atualizaÃ§Ã£o
          gh pr comment ${{ steps.check_pr.outputs.existing_pr }} --body "ğŸ¤– **DocumentaÃ§Ã£o atualizada automaticamente**

          Nova atualizaÃ§Ã£o baseada no commit: \`${{ github.sha }}\`
          
          ğŸ“… Atualizado em: $(date)
          ğŸ‘¤ Autor do commit: ${{ github.actor }}
          ğŸ¯ **Pronto para revisÃ£o e merge na main**"
          
          echo "âœ… PR atualizado com sucesso!"
          echo "ğŸ”— Verifique em: https://github.com/${{ github.repository }}/pull/${{ steps.check_pr.outputs.existing_pr }}"

      - name: ğŸ“Š Resumo da execuÃ§Ã£o
        run: |
          echo "## ğŸ“Š Resumo da ExecuÃ§Ã£o"
          echo "- Branch de trabalho: ${{ env.branch_name }}"
          echo "- Branch de destino: main"
          if [ "${{ steps.check_pr.outputs.has_existing_pr }}" == "true" ]; then
            echo "- AÃ§Ã£o: AtualizaÃ§Ã£o do PR #${{ steps.check_pr.outputs.existing_pr }} para merge na main"
          else
            echo "- AÃ§Ã£o: CriaÃ§Ã£o de novo PR para merge na main"
          fi
          if [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
            echo "- MudanÃ§as: âœ… DocumentaÃ§Ã£o atualizada e aguardando revisÃ£o"
          else
            echo "- MudanÃ§as: ğŸ“ Nenhuma mudanÃ§a detectada"
          fi
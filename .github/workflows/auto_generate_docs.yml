name: ğŸ“š Gerar DocumentaÃ§Ã£o Automaticamente

on:
  push:
    branches: [main, master]
  workflow_dispatch:

# Adiciona permissÃµes necessÃ¡rias
permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  doc-update:
    name: Atualizar documentaÃ§Ã£o automaticamente
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”„ Checkout do repositÃ³rio
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Busca todo o histÃ³rico para comparaÃ§Ãµes
          token: ${{ secrets.GITHUB_TOKEN }}  # Token explÃ­cito

      - name: ğŸ› ï¸ Instalar dependÃªncias necessÃ¡rias
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          python -m pip install --upgrade pip
          pip install -r requirements.txt  # Caminho correto

      - name: ğŸ” Verificar se jÃ¡ existe um PR aberto
        id: check_pr
        run: |
          prs=$(gh pr list --state open --search "AtualizaÃ§Ã£o automÃ¡tica da documentaÃ§Ã£o in:title" --json number -q '.[].number' | head -n 1)
          if [ -n "$prs" ] && [ "$prs" != "null" ]; then
            echo "PR jÃ¡ existe: $prs"
            echo "existing_pr=$prs" >> $GITHUB_OUTPUT
            echo "should_skip=true" >> $GITHUB_OUTPUT
          else
            echo "Nenhum PR existente"
            echo "existing_pr=" >> $GITHUB_OUTPUT
            echo "should_skip=false" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸª„ Criar branch para documentaÃ§Ã£o
        if: steps.check_pr.outputs.should_skip == 'false'
        run: |
          timestamp=$(date +%Y%m%d_%H%M%S)
          branch_name="docs/auto-update-$timestamp"
          git checkout -b $branch_name
          echo "branch_name=$branch_name" >> $GITHUB_ENV
          echo "âœ… Branch criada: $branch_name"

      - name: ğŸ“¦ Executar Agentes de DocumentaÃ§Ã£o
        if: steps.check_pr.outputs.should_skip == 'false'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
        run: |
          cd readocs
          python main.py

      - name: ğŸ” Verificar mudanÃ§as
        if: steps.check_pr.outputs.should_skip == 'false'
        id: check_changes
        run: |
          git add README.md CHANGELOG.md || true
          if git diff --cached --quiet; then
            echo "ğŸ“ Nenhuma mudanÃ§a detectada na documentaÃ§Ã£o"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“ MudanÃ§as detectadas na documentaÃ§Ã£o"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            git status
          fi

      - name: âœ… Commit e push se houver mudanÃ§as
        if: steps.check_pr.outputs.should_skip == 'false' && steps.check_changes.outputs.has_changes == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸš€ Criando commit e PR..."
          
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          git commit -m "docs: atualizaÃ§Ã£o automÃ¡tica da documentaÃ§Ã£o [skip ci]"
          git push origin HEAD
          
          echo "âœ… Push realizado para branch: ${{ env.branch_name }}"

      - name: ğŸ“¤ Criar Pull Request
        if: steps.check_pr.outputs.should_skip == 'false' && steps.check_changes.outputs.has_changes == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pr_body="## ğŸ“š AtualizaÃ§Ã£o AutomÃ¡tica da DocumentaÃ§Ã£o

          Esta Ã© uma atualizaÃ§Ã£o automÃ¡tica da documentaÃ§Ã£o gerada pelos agentes IA.

          ### ğŸ¤– MudanÃ§as Realizadas:
          - âœ… README.md atualizado com anÃ¡lise do projeto
          - âœ… CHANGELOG.md atualizado com nova versÃ£o
          
          ### ğŸ“‹ Detalhes:
          - **Trigger**: ${{ github.event_name }}
          - **Branch**: ${{ github.ref_name }}
          - **Commit**: ${{ github.sha }}
          - **Autor**: ${{ github.actor }}
          
          ---
          ğŸ¤– *Gerado automaticamente pelo GitHub Actions*"

          pr_number=$(gh pr create \
            --title "ğŸ“š AtualizaÃ§Ã£o automÃ¡tica da documentaÃ§Ã£o" \
            --body "$pr_body" \
            --label "documentation,automated" \
            # --assignee julsales \  # Descomente para assignee fixo
            --json number --jq .number)

          echo "âœ… PR #$pr_number criado com sucesso!"
          echo "ğŸ”— Verifique em: https://github.com/${{ github.repository }}/pull/$pr_number"

      - name: â­ï¸ Skip - PR jÃ¡ existe
        if: steps.check_pr.outputs.should_skip == 'true'
        run: |
          echo "â­ï¸ Pulando execuÃ§Ã£o - PR #${{ steps.check_pr.outputs.existing_pr }} jÃ¡ existe"
          echo "ğŸ”— Verifique em: https://github.com/${{ github.repository }}/pull/${{ steps.check_pr.outputs.existing_pr }}"
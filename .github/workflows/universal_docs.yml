name: ğŸ“š DocumentaÃ§Ã£o Universal com Readocs

on:
  push:
    branches: [main, master]
  workflow_dispatch:

# Adiciona permissÃµes necessÃ¡rias
permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  doc-update:
    name: Atualizar documentaÃ§Ã£o automaticamente
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”„ Checkout do repositÃ³rio
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ğŸ› ï¸ Instalar Readocs Universal
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          python -m pip install --upgrade pip
          
          # Instalar Readocs diretamente do repositÃ³rio
          pip install git+https://github.com/${{ github.repository_owner }}/Readocs.git
          
          # DependÃªncias essenciais do Readocs
          pip install anthropic google-generativeai agno typer rich pathlib

      - name: ğŸ” Verificar se jÃ¡ existe um PR aberto
        id: check_pr
        run: |
          pr_info=$(gh pr list --state open --search "ğŸ“š DocumentaÃ§Ã£o automÃ¡tica" --json number,headRefName --jq '.[0]')
          
          if [ "$pr_info" != "null" ] && [ -n "$pr_info" ]; then
            pr_number=$(echo "$pr_info" | jq -r '.number')
            branch_name=$(echo "$pr_info" | jq -r '.headRefName')
            echo "PR existente encontrado: #$pr_number na branch: $branch_name"
            echo "existing_pr=$pr_number" >> $GITHUB_OUTPUT
            echo "existing_branch=$branch_name" >> $GITHUB_OUTPUT
            echo "has_existing_pr=true" >> $GITHUB_OUTPUT
          else
            echo "Nenhum PR existente encontrado"
            echo "existing_pr=" >> $GITHUB_OUTPUT
            echo "existing_branch=" >> $GITHUB_OUTPUT
            echo "has_existing_pr=false" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸª„ Usar branch existente ou criar nova
        run: |
          if [ "${{ steps.check_pr.outputs.has_existing_pr }}" == "true" ]; then
            # Usar branch existente
            branch_name="${{ steps.check_pr.outputs.existing_branch }}"
            echo "ğŸ”„ Usando branch existente: $branch_name"
            git fetch origin $branch_name
            git checkout $branch_name
          else
            # Criar nova branch
            timestamp=$(date +%Y%m%d_%H%M%S)
            branch_name="docs/readocs-auto-$timestamp"
            echo "ğŸª„ Criando nova branch: $branch_name"
            git checkout -b $branch_name
          fi
          echo "branch_name=$branch_name" >> $GITHUB_ENV

      - name: ğŸ“¦ Executar Readocs Universal
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          READOCS_MODEL_ID: ${{ secrets.READOCS_MODEL_ID || 'claude-3-haiku-20240307' }}
        run: |
          echo "ğŸš€ Executando Readocs Universal no projeto atual..."
          echo "ğŸ“ DiretÃ³rio: $(pwd)"
          echo "ğŸ“‚ Arquivos no diretÃ³rio:"
          ls -la
          
          # Executar Readocs Universal
          python -m readocs generate . || {
            echo "âš ï¸ Erro ao executar Readocs. Tentando modo dry-run..."
            python -m readocs generate . --dry-run
          }

      - name: ğŸ”§ Configurar badges dinÃ¢micos
        run: |
          REPO_FULL="${{ github.repository }}"
          REPO_OWNER="${{ github.repository_owner }}"
          REPO_NAME=$(echo "$REPO_FULL" | cut -d'/' -f2)
          
          BADGE_HTML="<div align=\"center\">

          <img src=\"https://img.shields.io/github/repo-size/$REPO_FULL?style=for-the-badge\">
          <img src=\"https://img.shields.io/github/languages/count/$REPO_FULL?style=for-the-badge\">
          <img src=\"https://img.shields.io/github/forks/$REPO_FULL?style=for-the-badge\">
          <img src=\"https://img.shields.io/github/issues/$REPO_FULL?style=for-the-badge\">
          <img src=\"https://img.shields.io/github/issues-pr/$REPO_FULL?style=for-the-badge\">
          <br><br>
          </div>"

          # Substituir {{BADGE_SECTION}} se existir
          if [ -f README.md ]; then
            awk -v replacement="$BADGE_HTML" '
              {
                gsub(/\{\{BADGE_SECTION\}\}/, replacement)
                print
              }
            ' README.md > README.tmp && mv README.tmp README.md
          fi

      - name: ğŸ” Verificar mudanÃ§as
        id: check_changes
        run: |
          git add README.md CHANGELOG.md || true
          if git diff --cached --quiet; then
            echo "ğŸ“ Nenhuma mudanÃ§a detectada na documentaÃ§Ã£o"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“ MudanÃ§as detectadas na documentaÃ§Ã£o"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ“‹ Arquivos modificados:"
            git status --porcelain
          fi

      - name: âœ… Commit e push mudanÃ§as
        if: steps.check_changes.outputs.has_changes == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          commit_msg="ğŸ“š docs: atualizaÃ§Ã£o automÃ¡tica com Readocs Universal [skip ci]"
          if [ "${{ steps.check_pr.outputs.has_existing_pr }}" == "true" ]; then
            commit_msg="ğŸ“š docs: atualizaÃ§Ã£o da documentaÃ§Ã£o (PR #${{ steps.check_pr.outputs.existing_pr }}) [skip ci]"
          fi
          
          git commit -m "$commit_msg"
          git push origin HEAD
          
          echo "âœ… Push realizado para branch: ${{ env.branch_name }}"

      - name: ğŸ“¤ Criar Pull Request (se novo)
        if: steps.check_changes.outputs.has_changes == 'true' && steps.check_pr.outputs.has_existing_pr == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Detectar tipo de projeto
          PROJECT_TYPES=""
          [ -f "package.json" ] && PROJECT_TYPES="$PROJECT_TYPES Node.js"
          [ -f "requirements.txt" ] && PROJECT_TYPES="$PROJECT_TYPES Python"
          [ -f "pom.xml" ] && PROJECT_TYPES="$PROJECT_TYPES Java"
          [ -f "go.mod" ] && PROJECT_TYPES="$PROJECT_TYPES Go"
          [ -f "Cargo.toml" ] && PROJECT_TYPES="$PROJECT_TYPES Rust"
          [ -z "$PROJECT_TYPES" ] && PROJECT_TYPES=" GenÃ©rico"

          pr_body="## ğŸ“š DocumentaÃ§Ã£o AutomÃ¡tica com Readocs Universal

          Esta Ã© uma atualizaÃ§Ã£o automÃ¡tica da documentaÃ§Ã£o gerada pelo **Readocs Universal**.

          ### ğŸ¤– MudanÃ§as Realizadas:
          - âœ… README.md atualizado com anÃ¡lise inteligente do projeto
          - âœ… CHANGELOG.md atualizado com nova versÃ£o
          - ğŸ¯ DocumentaÃ§Ã£o adaptada para projeto:$PROJECT_TYPES
          
          ### ğŸ“‹ Detalhes TÃ©cnicos:
          - **RepositÃ³rio**: ${{ github.repository }}
          - **Trigger**: ${{ github.event_name }}
          - **Branch origem**: ${{ env.branch_name }}
          - **Branch destino**: ${{ github.ref_name }}
          - **Commit**: \`${{ github.sha }}\`
          - **Autor**: ${{ github.actor }}
          
          ### ğŸ” Como Foi Gerado:
          1. ğŸš€ Readocs Universal analisou automaticamente o projeto
          2. ğŸ§  IA (Claude/Gemini) gerou documentaÃ§Ã£o personalizada
          3. ğŸ“ Arquivos README.md e CHANGELOG.md foram atualizados
          4. ğŸ”„ PR criado automaticamente para revisÃ£o
          
          ### âš ï¸ RevisÃ£o NecessÃ¡ria
          Por favor, revise as mudanÃ§as antes de fazer o merge.
          
          ---
          ğŸ¤– *Gerado automaticamente pelo **Readocs Universal** via GitHub Actions*
          ğŸ”— [Saiba mais sobre o Readocs](https://github.com/${{ github.repository_owner }}/Readocs)"

          pr_url=$(gh pr create \
            --title "ğŸ“š DocumentaÃ§Ã£o automÃ¡tica com Readocs Universal" \
            --body "$pr_body" \
            --base ${{ github.ref_name }} \
            --head ${{ env.branch_name }} \
            --label "documentation,readocs,automated")

          echo "âœ… Novo PR criado!"
          echo "ğŸ”— Acesse: $pr_url"

      - name: ğŸ”„ Atualizar PR existente
        if: steps.check_changes.outputs.has_changes == 'true' && steps.check_pr.outputs.has_existing_pr == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ”„ PR #${{ steps.check_pr.outputs.existing_pr }} foi atualizado"
          
          # Adiciona comentÃ¡rio no PR sobre a atualizaÃ§Ã£o
          gh pr comment ${{ steps.check_pr.outputs.existing_pr }} --body "ğŸ¤– **Readocs Universal - Nova AtualizaÃ§Ã£o**

          ğŸ“ DocumentaÃ§Ã£o atualizada automaticamente
          
          **Detalhes da AtualizaÃ§Ã£o:**
          - ğŸ“… **Quando**: $(date)
          - ğŸ’» **Commit**: \`${{ github.sha }}\`
          - ğŸ‘¤ **Autor**: ${{ github.actor }}
          - ğŸ¯ **Status**: âœ… Pronto para revisÃ£o
          
          ---
          ğŸ¤– *Processado pelo Readocs Universal*"
          
          echo "âœ… PR atualizado com sucesso!"

      - name: ğŸ“Š Resumo da execuÃ§Ã£o
        run: |
          echo "## ğŸ“Š Readocs Universal - Resumo da ExecuÃ§Ã£o"
          echo ""
          echo "### ğŸ¯ Projeto Analisado:"
          echo "- **RepositÃ³rio**: ${{ github.repository }}"
          echo "- **Branch**: ${{ github.ref_name }}"
          echo "- **DiretÃ³rio**: $(pwd)"
          echo ""
          echo "### ğŸ”„ AÃ§Ãµes Realizadas:"
          echo "- **Branch de trabalho**: ${{ env.branch_name }}"
          if [ "${{ steps.check_pr.outputs.has_existing_pr }}" == "true" ]; then
            echo "- **AÃ§Ã£o**: AtualizaÃ§Ã£o do PR #${{ steps.check_pr.outputs.existing_pr }}"
          else
            echo "- **AÃ§Ã£o**: CriaÃ§Ã£o de novo PR"
          fi
          if [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
            echo "- **Resultado**: âœ… DocumentaÃ§Ã£o atualizada e aguardando revisÃ£o"
          else
            echo "- **Resultado**: ğŸ“ Nenhuma mudanÃ§a detectada"
          fi
          echo ""
          echo "ğŸš€ **Readocs Universal funcionou perfeitamente!**"
